<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guía de Aprendizaje - Flujo sin API (U. de Los Lagos)</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Impresión / PDF (Guardar como PDF desde el navegador) */
    @media print {
      .no-print { display: none !important; }
      body { background: #fff !important; padding: 0 !important; margin: 0 !important; }
      #printable-area { box-shadow: none !important; border: none !important; }
      textarea, input, select {
        border: none !important;
        background: transparent !important;
        resize: none !important;
        overflow: hidden !important;
        appearance: none !important;
        -webkit-appearance: none !important;
        min-height: auto !important;
        padding: 0 !important;
      }
      .section-title {
        background-color: #1e3a8a !important;
        color: #fff !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      table { page-break-inside: auto; }
      tr { page-break-inside: avoid; page-break-after: auto; }
      .print-hint { display: none !important; }
    }

    .section-title {
      background-color: #1e3a8a;
      color: #fff;
      padding: 10px 14px;
      font-weight: 700;
      border-radius: 8px;
      margin-top: 22px;
      margin-bottom: 10px;
    }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    th, td { border: 1px solid #cbd5e1; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
    th { background: #f8fafc; font-weight: 600; color: #334155; font-size: 0.85rem; }
    textarea, input[type="text"], input[type="number"], select {
      width: 100%;
      min-height: 38px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px;
      font-size: 0.9rem;
      background: #fff;
    }

    .btn {
      border-radius: 10px;
      padding: 12px 18px;
      font-weight: 700;
      transition: transform 0.12s ease, background 0.12s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: #1d4ed8; color: #fff; }
    .btn-primary:hover { background: #1e40af; }
    .btn-violet { background: #7c3aed; color: #fff; }
    .btn-violet:hover { background: #6d28d9; }
    .btn-slate { background: #475569; color: #fff; }
    .btn-slate:hover { background: #334155; }
    .btn-green { background: #10b981; color: #fff; }
    .btn-green:hover { background: #059669; }
    .btn-outline {
      background: #fff;
      border: 1px solid #cbd5e1;
      color: #0f172a;
    }
    .btn-outline:hover { background: #f8fafc; }

    .badge-step {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: #0f172a;
      color: #fff;
      font-weight: 800;
      margin-right: 10px;
      flex: none;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
    }
    .modal-card {
      width: min(980px, 96vw);
      max-height: 90vh;
      overflow: auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
      border: 1px solid #e2e8f0;
    }
    .modal-header {
      padding: 14px 16px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .modal-body { padding: 16px; }
    pre {
      background: #0b1220;
      color: #e5e7eb;
      padding: 14px;
      border-radius: 12px;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.9rem;
      line-height: 1.35rem;
    }

    .warning-box {
      border: 2px solid #ea580c;
      background: #fff7ed;
      color: #9a3412;
      padding: 14px;
      border-radius: 12px;
      margin-top: 18px;
      font-size: 0.95rem;
    }
  </style>
</head>

<body class="bg-slate-100 text-slate-900 font-sans p-4 md:p-8">
  <div class="max-w-6xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden p-6 md:p-10" id="printable-area">

    <header class="text-center border-b pb-6 mb-6">
      <h1 class="text-3xl font-extrabold text-slate-800 uppercase">Guía de Aprendizaje 2026</h1>
      <p class="text-blue-700 font-semibold italic mt-2">
        Flujo sin API: Formulario → PDF → Gemini (manual) → Resultado final
      </p>
      <p class="text-xs text-slate-500 mt-2 no-print">
        Recomendación: use Chrome o Edge. Para PDF: “Imprimir” → “Guardar como PDF”.
      </p>
    </header>

    <!-- PASOS -->
    <section class="no-print">
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
        <h2 class="text-lg font-extrabold text-slate-800 mb-3">Instrucciones (flujo completo)</h2>

        <div class="space-y-4">
          <div class="flex items-start gap-3">
            <span class="badge-step">1</span>
            <div>
              <p class="font-bold">Paso 1: Complete el formulario base.</p>
              <p class="text-sm text-slate-600">
                Ingrese los datos mínimos: nombre de asignatura, Resultados de Aprendizaje (RA) y saberes.
                Mientras más claro esté, mejor será la propuesta que genere Gemini.
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <span class="badge-step">2</span>
            <div>
              <p class="font-bold">Paso 2: Genere el PDF base (entrada para Gemini).</p>
              <p class="text-sm text-slate-600">
                Presione “Descargar PDF (Guía base)”. Se abrirá la impresión del navegador:
                seleccione “Guardar como PDF”. Ese archivo será el que adjuntará a Gemini.
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <span class="badge-step">3</span>
            <div>
              <p class="font-bold">Paso 3: Abra Gemini en una pestaña aparte.</p>
              <p class="text-sm text-slate-600">
                En Gemini, iniciará una nueva conversación para generar la planificación (17 semanas) y el cronograma de evaluaciones.
              </p>
            </div>
          </div>

          <div class="flex items-start gap-3">
            <span class="badge-step">4</span>
            <div>
              <p class="font-bold">Paso 4: Copie el prompt y adjunte el PDF en Gemini.</p>
              <p class="text-sm text-slate-600">
                Presione “Ver y Copiar Prompt”. En Gemini: pegue el prompt y adjunte el PDF descargado en el paso 2.
                Solicite que el resultado quede en tablas claras (Plan 17 semanas + Cronograma).
              </p>
            </div>
          </div>
        </div>

        <div class="mt-5 flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-center">
          <button class="btn btn-primary" onclick="handlePrint()">
            Descargar PDF (Guía base)
          </button>

          <a class="btn btn-violet text-center" href="https://gemini.google.com/" target="_blank" rel="noopener noreferrer">
            Abrir Gemini (nueva pestaña)
          </a>

          <button class="btn btn-slate" onclick="openPromptModal()">
            Ver y Copiar Prompt
          </button>

          <button class="btn btn-outline" onclick="clearForm()">
            Limpiar formulario
          </button>
        </div>

        <div class="warning-box mt-5">
          <strong>Nota:</strong> Esta herramienta no utiliza API ni accede a su cuenta de Gemini.
          El docente controla el proceso: genera el PDF base y luego usa Gemini manualmente con el prompt sugerido.
        </div>
      </div>
    </section>

    <!-- FORMULARIO (IMPRIMIBLE) -->
    <div id="content-form">
      <div class="section-title">1. IDENTIFICACIÓN DE LA ASIGNATURA</div>
      <table>
        <tr>
          <th class="w-1/4">Nombre Asignatura</th>
          <td><textarea id="field-asignatura" placeholder="Ej.: Algoritmos y Estructuras de Datos"></textarea></td>
          <th class="w-1/4">Carrera</th>
          <td><textarea id="field-carrera" placeholder="Ej.: Ingeniería en Informática"></textarea></td>
        </tr>
        <tr>
          <th>Semestre</th>
          <td>
            <select id="field-semestre">
              <option>Primer Semestre</option>
              <option>Segundo Semestre</option>
            </select>
          </td>
          <th>Sección</th>
          <td><textarea id="field-seccion" placeholder="Ej.: 01"></textarea></td>
        </tr>
        <tr>
          <th>Docente</th>
          <td><textarea id="field-docente" placeholder="Nombre del docente"></textarea></td>
          <th>Correo</th>
          <td><textarea id="field-correo" placeholder="correo@ulagos.cl"></textarea></td>
        </tr>
      </table>

      <div class="section-title">2. APORTES AL PERFIL DE EGRESO</div>
      <table>
        <thead>
          <tr>
            <th class="w-2/3">Competencia</th>
            <th class="w-1/3">Nivel de dominio</th>
          </tr>
        </thead>
        <tbody id="competencias-container">
          <tr class="row-generica" data-type="generica">
            <td>
              <strong>General:</strong>
              <textarea class="val-comp" placeholder="Competencia general..."></textarea>
              <div class="no-print mt-2 btn-container">
                <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addCompRow('generica')">+ Agregar más</button>
              </div>
            </td>
            <td><textarea class="val-nivel" placeholder="Ej.: Básico / Intermedio / Avanzado"></textarea></td>
          </tr>

          <tr class="row-especifica" data-type="especifica">
            <td>
              <strong>Específica:</strong>
              <textarea class="val-comp" placeholder="Competencia específica..."></textarea>
              <div class="no-print mt-2 btn-container">
                <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addCompRow('especifica')">+ Agregar más</button>
              </div>
            </td>
            <td><textarea class="val-nivel" placeholder="Ej.: Básico / Intermedio / Avanzado"></textarea></td>
          </tr>
        </tbody>
      </table>

      <div class="section-title">4. RESULTADOS DE APRENDIZAJE (RA)</div>
      <table>
        <tbody id="ra-container">
          <tr class="row-ra">
            <td class="text-center font-extrabold w-20">RA1</td>
            <td>
              <textarea class="val-ra" placeholder="Redacte el Resultado de Aprendizaje (RA) en forma observable y evaluable..."></textarea>
              <div class="no-print mt-2 container-btn-ra">
                <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addRARow()">+ Agregar RA</button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="section-title">5. SABERES DE LA ASIGNATURA (por RA)</div>
      <table>
        <thead>
          <tr>
            <th class="w-24 text-center">RA</th>
            <th>Conceptuales</th>
            <th>Procedimentales</th>
            <th>Actitudinales</th>
          </tr>
        </thead>
        <tbody id="saberes-container">
          <tr class="row-saberes-ra" data-ra="RA1">
            <td class="text-center font-extrabold bg-slate-50">RA1</td>
            <td><textarea class="val-con" placeholder="Saber conceptual..."></textarea></td>
            <td><textarea class="val-pro" placeholder="Saber procedimental..."></textarea></td>
            <td><textarea class="val-act" placeholder="Saber actitudinal..."></textarea></td>
          </tr>
        </tbody>
      </table>

      <div class="section-title">5.1. ESQUEMA DE NOTAS (por RA)</div>
      <table>
        <thead>
          <tr>
            <th class="w-24 text-center">RA</th>
            <th>Tipo de Evaluación</th>
            <th class="w-40">Ponderación (%)</th>
          </tr>
        </thead>
        <tbody id="notas-container"></tbody>
      </table>

      <div class="section-title">6. PLANIFICACIÓN DE SESIONES (17 SEMANAS)</div>
      <p class="text-sm text-slate-600 mb-3 print-hint">
        Esta sección se completa en Gemini (manual). El PDF base sirve como insumo para que Gemini genere la propuesta.
      </p>
      <table class="text-[12px]">
        <thead>
          <tr>
            <th class="w-12">Sem.</th>
            <th class="w-16">RA</th>
            <th>Saber conceptual</th>
            <th>Docencia directa</th>
            <th>Trabajo autónomo</th>
            <th class="w-28">Recursos</th>
          </tr>
        </thead>
        <tbody id="semanas-container"></tbody>
      </table>

      <div class="section-title">6.1. CRONOGRAMA DE EVALUACIONES (PROCESO Y PRODUCTO)</div>
      <p class="text-sm text-slate-600 mb-3 print-hint">
        Esta sección se completa en Gemini (manual), considerando el esquema de notas, ponderaciones y progresión de RA.
      </p>
      <table class="text-[12px]">
        <thead>
          <tr>
            <th class="w-24">Fecha / Sem.</th>
            <th class="w-16">RA</th>
            <th class="w-32">Tipo</th>
            <th>Medio de Evaluación</th>
            <th>Instrumento</th>
            <th class="w-20">Pond.</th>
          </tr>
        </thead>
        <tbody>
          <!-- Dejar vacío como guía. Gemini generará el contenido fuera. -->
          <tr>
            <td class="text-slate-400 italic text-center" colspan="6">
              (Se completa en Gemini. En el resultado final, pegue aquí o use el documento generado por Gemini.)
            </td>
          </tr>
        </tbody>
      </table>

      <div class="warning-box">
        <strong>⚠️ Nota importante:</strong> Esta guía base se genera como insumo. La propuesta de planificación/cronograma
        que elabore Gemini debe ser revisada y ajustada por el docente antes de considerarla definitiva.
      </div>

      <div class="mt-10 no-print flex flex-col md:flex-row gap-3 justify-center">
        <button class="btn btn-primary" onclick="handlePrint()">Descargar PDF (Guía base)</button>
        <a class="btn btn-violet text-center" href="https://gemini.google.com/" target="_blank" rel="noopener noreferrer">Abrir Gemini</a>
        <button class="btn btn-slate" onclick="openPromptModal()">Ver y Copiar Prompt</button>
      </div>
    </div>
  </div>

  <!-- MODAL PROMPT -->
  <div id="promptModal" class="modal-backdrop no-print" role="dialog" aria-modal="true" aria-labelledby="promptTitle">
    <div class="modal-card">
      <div class="modal-header">
        <div>
          <h3 id="promptTitle" class="text-lg font-extrabold text-slate-800">Paso 4: Prompt para Gemini (copiar y pegar)</h3>
          <p class="text-sm text-slate-600">
            En Gemini: pegue este prompt y adjunte el PDF generado en el Paso 2.
          </p>
        </div>
        <button class="btn btn-outline !py-2 !px-3" onclick="closePromptModal()">Cerrar</button>
      </div>

      <div class="modal-body">
        <div class="flex flex-col md:flex-row gap-3 md:items-center md:justify-between mb-3">
          <p class="text-sm text-slate-700">
            Recomendación: mantenga el formato de tablas y evite texto innecesario. Pida coherencia con RA y ponderaciones.
          </p>
          <div class="flex gap-2">
            <button class="btn btn-green !py-2 !px-3" onclick="copyPrompt()">Copiar</button>
            <button class="btn btn-outline !py-2 !px-3" onclick="fillPromptFromForm()">Actualizar prompt con datos del formulario</button>
          </div>
        </div>

        <pre id="promptText"></pre>

        <div id="copyStatus" class="text-sm mt-3 text-slate-600"></div>

        <div class="warning-box mt-5">
          <strong>Instrucciones:</strong>
          <ol class="list-decimal ml-5 mt-2">
            <li>Abra Gemini (Paso 3).</li>
            <li>Adjunte el PDF “Guía base” que descargó (Paso 2).</li>
            <li>Pegue este prompt y envíelo.</li>
            <li>Guarde/Imprima el resultado de Gemini como PDF (si lo necesita).</li>
          </ol>
        </div>
      </div>
    </div>
  </div>

  <script>
    let raCount = 1;

    function initApp() {
      initSemanas();
      addNotaRowToRA(1);
      setDefaultPrompt();
    }

    function handlePrint() {
      // Guardar como PDF desde la impresora del navegador
      window.focus();
      window.print();
    }

    function initSemanas() {
      const container = document.getElementById('semanas-container');
      container.innerHTML = '';
      for (let i = 1; i <= 17; i++) {
        container.innerHTML += `
          <tr class="sem-row-${i}">
            <td class="text-center font-extrabold bg-slate-50">${i}</td>
            <td class="text-center"><textarea class="val-ra-display text-center" readonly placeholder="RAx"></textarea></td>
            <td><textarea class="sem-con text-[12px] min-h-[44px]" placeholder="(Se completa en Gemini)"></textarea></td>
            <td><textarea class="sem-dir text-[12px] min-h-[44px]" placeholder="(Se completa en Gemini)"></textarea></td>
            <td><textarea class="sem-aut text-[12px] min-h-[44px]" placeholder="(Se completa en Gemini)"></textarea></td>
            <td><textarea class="sem-rec text-[12px] min-h-[44px]" placeholder="(Se completa en Gemini)"></textarea></td>
          </tr>
        `;
      }
    }

    function addCompRow(type) {
      const container = document.getElementById('competencias-container');
      const label = type === 'generica' ? 'General:' : 'Específica:';

      const existingRows = document.querySelectorAll(\`.row-\${type}\`);
      if (existingRows.length > 0) {
        const lastRow = existingRows[existingRows.length - 1];
        const btnContainer = lastRow.querySelector('.btn-container');
        if (btnContainer) btnContainer.remove();
      }

      const newRow = document.createElement('tr');
      newRow.className = \`row-\${type}\`;
      newRow.innerHTML = `
        <td>
          <strong>${label}</strong>
          <textarea class="val-comp" placeholder="Competencia..."></textarea>
          <div class="no-print mt-2 btn-container">
            <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addCompRow('${type}')">+ Agregar más</button>
          </div>
        </td>
        <td><textarea class="val-nivel" placeholder="Ej.: Básico / Intermedio / Avanzado"></textarea></td>
      `;

      if (existingRows.length > 0) {
        existingRows[existingRows.length - 1].after(newRow);
      } else {
        container.appendChild(newRow);
      }
    }

    function addRARow() {
      raCount++;
      const container = document.getElementById('ra-container');
      document.querySelectorAll('.container-btn-ra').forEach(el => el.remove());

      const newRow = document.createElement('tr');
      newRow.className = 'row-ra';
      newRow.innerHTML = `
        <td class="text-center font-extrabold w-20">RA${raCount}</td>
        <td>
          <textarea class="val-ra" placeholder="Redacte el Resultado de Aprendizaje (RA) en forma observable y evaluable..."></textarea>
          <div class="no-print mt-2 container-btn-ra">
            <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addRARow()">+ Agregar RA</button>
          </div>
        </td>
      `;
      container.appendChild(newRow);

      const saberesContainer = document.getElementById('saberes-container');
      saberesContainer.innerHTML += `
        <tr class="row-saberes-ra" data-ra="RA${raCount}">
          <td class="text-center font-extrabold bg-slate-50">RA${raCount}</td>
          <td><textarea class="val-con" placeholder="Saber conceptual..."></textarea></td>
          <td><textarea class="val-pro" placeholder="Saber procedimental..."></textarea></td>
          <td><textarea class="val-act" placeholder="Saber actitudinal..."></textarea></td>
        </tr>
      `;

      addNotaRowToRA(raCount);
    }

    function addNotaRowToRA(numRA) {
      const container = document.getElementById('notas-container');
      const items = document.querySelectorAll(\`.ra-item-\${numRA}\`);
      const isFirst = items.length === 0;

      const newRow = document.createElement('tr');
      newRow.className = \`ra-item-\${numRA}\`;
      newRow.innerHTML = `
        <td class="text-center font-extrabold bg-slate-50">
          ${isFirst ? `RA${numRA} <div class="no-print"><button title="Agregar otra evaluación a este RA" onclick="addNotaRowToRA(${numRA})" class="text-green-700 font-extrabold">+</button></div>` : ''}
        </td>
        <td>
          <select>
            <option>Proceso</option>
            <option>Producto</option>
          </select>
        </td>
        <td><input type="text" placeholder="Ej.: 25%"></td>
      `;

      if (!isFirst) {
        items[items.length - 1].after(newRow);
      } else {
        container.appendChild(newRow);
      }
    }

    /* ===== Modal Prompt ===== */
    function openPromptModal() {
      document.getElementById('copyStatus').textContent = '';
      document.getElementById('promptModal').style.display = 'flex';
      // Por defecto, intentamos cargar un prompt con datos actuales
      fillPromptFromForm();
    }

    function closePromptModal() {
      document.getElementById('promptModal').style.display = 'none';
    }

    function setDefaultPrompt() {
      document.getElementById('promptText').textContent = buildPrompt(null);
    }

    function normalizeText(s) {
      return (s || '').toString().trim().replace(/\s+/g, ' ');
    }

    function collectContext() {
      const asignatura = normalizeText(document.getElementById('field-asignatura').value);
      const carrera = normalizeText(document.getElementById('field-carrera').value);
      const semestre = normalizeText(document.getElementById('field-semestre').value);
      const seccion = normalizeText(document.getElementById('field-seccion').value);
      const docente = normalizeText(document.getElementById('field-docente').value);

      const ras = Array.from(document.querySelectorAll('.row-ra')).map((row, idx) => {
        const label = `RA${idx+1}`;
        const val = normalizeText(row.querySelector('.val-ra')?.value);
        return { label, value: val };
      });

      const saberes = Array.from(document.querySelectorAll('.row-saberes-ra')).map((row) => {
        const ra = row.dataset.ra || '';
        const con = normalizeText(row.querySelector('.val-con')?.value);
        const pro = normalizeText(row.querySelector('.val-pro')?.value);
        const act = normalizeText(row.querySelector('.val-act')?.value);
        return { ra, con, pro, act };
      });

      const notas = Array.from(document.querySelectorAll('#notas-container tr')).map((tr) => {
        const raCell = tr.querySelector('td')?.innerText || '';
        const ra = normalizeText(raCell).split(' ')[0] || ''; // "RA1"
        const tipo = normalizeText(tr.querySelector('select')?.value);
        const pond = normalizeText(tr.querySelector('input')?.value);
        return { ra, tipo, pond };
      }).filter(x => x.ra || x.tipo || x.pond);

      return { asignatura, carrera, semestre, seccion, docente, ras, saberes, notas };
    }

    function buildPrompt(ctx) {
      const header = `
Actúa como diseñador instruccional universitario en Chile. Vas a trabajar con un PDF adjunto llamado "Guía base", que contiene: identificación, competencias, Resultados de Aprendizaje (RA), saberes por RA y esquema de notas.

INSTRUCCIONES IMPORTANTES:
- Usa el PDF como fuente principal. No inventes información que no esté en el PDF.
- Si falta algún dato crítico, plantea una lista corta de supuestos razonables y continúa.
- Mantén coherencia: progresión por semanas, alineación RA ↔ saberes ↔ evaluaciones.
- La planificación es para 17 semanas.
- Entrega el resultado en formato claro y utilizable por un docente.

SALIDAS REQUERIDAS (sin texto extra):
A) TABLA 6: Planificación de 17 semanas (una fila por semana) con columnas:
   - Semana (1..17)
   - RA (RA1, RA2, etc.)
   - Saber conceptual (resumen)
   - Docencia directa (actividades del docente)
   - Trabajo autónomo (actividades del estudiante)
   - Recursos (bibliografía, herramientas, LMS, etc.)

B) TABLA 6.1: Cronograma de evaluaciones (Proceso y Producto) con:
   - Semana o Fecha/Semana
   - RA
   - Tipo (Proceso/Producto)
   - Medio de evaluación (prueba, informe, proyecto, exposición, etc.)
   - Instrumento (rúbrica, pauta, lista de cotejo, etc.)
   - Ponderación (porcentaje)

C) Validación rápida al final (máximo 6 líneas):
   - ¿Las evaluaciones cubren todos los RA?
   - ¿Las ponderaciones suman 100%? Si el PDF no define ponderaciones, propón una distribución razonable y consistente.

Ahora, con el PDF adjunto, genera TABLA 6 y TABLA 6.1.`;

      if (!ctx) return normalizeText(header);

      // Bloque contextual opcional: mejora precisión si Gemini no lee perfecto el PDF.
      const ctxBlock = `
CONTEXTO EXTRAÍDO (para ayudarte a leer el PDF; prioriza el PDF si hay discrepancias):
- Asignatura: ${ctx.asignatura || '(no especificada)'}
- Carrera: ${ctx.carrera || '(no especificada)'}
- Semestre: ${ctx.semestre || '(no especificado)'}
- Sección: ${ctx.seccion || '(no especificada)'}
- Docente: ${ctx.docente || '(no especificado)'}

RESULTADOS DE APRENDIZAJE (RA):
${ctx.ras.map(r => `- ${r.label}: ${r.value || '(vacío)'}`).join('\n')}

SABERES POR RA:
${ctx.saberes.map(s => `- ${s.ra}: Conceptual=${s.con || '(vacío)'} | Procedimental=${s.pro || '(vacío)'} | Actitudinal=${s.act || '(vacío)'}`).join('\n')}

ESQUEMA DE NOTAS (si aplica):
${ctx.notas.length ? ctx.notas.map(n => `- ${n.ra}: ${n.tipo || '(tipo?)'} ${n.pond || '(ponderación?)'}`).join('\n') : '- (no informado)'}
`;

      return `${normalizeText(header)}\n\n${ctxBlock.trim()}`;
    }

    function fillPromptFromForm() {
      const ctx = collectContext();
      document.getElementById('promptText').textContent = buildPrompt(ctx);
    }

    async function copyPrompt() {
      const text = document.getElementById('promptText').textContent || '';
      const status = document.getElementById('copyStatus');

      try {
        await navigator.clipboard.writeText(text);
        status.textContent = 'Listo: prompt copiado al portapapeles. En Gemini, péguelo y adjunte el PDF de la Guía base.';
        status.className = 'text-sm mt-3 text-green-700 font-semibold';
      } catch (e) {
        // Fallback: seleccionar texto para copiar manualmente
        status.textContent = 'No fue posible copiar automáticamente. Seleccione el texto del prompt y copie manualmente (Ctrl+C).';
        status.className = 'text-sm mt-3 text-amber-700 font-semibold';
      }
    }

    function clearForm() {
      // Limpia inputs/textarea/select del formulario
      document.querySelectorAll('textarea').forEach(t => t.value = '');
      document.querySelectorAll('input[type="text"], input[type="number"]').forEach(i => i.value = '');
      document.getElementById('field-semestre').selectedIndex = 0;

      // Reset RA a 1
      raCount = 1;

      // Reset RA container
      document.getElementById('ra-container').innerHTML = `
        <tr class="row-ra">
          <td class="text-center font-extrabold w-20">RA1</td>
          <td>
            <textarea class="val-ra" placeholder="Redacte el Resultado de Aprendizaje (RA) en forma observable y evaluable..."></textarea>
            <div class="no-print mt-2 container-btn-ra">
              <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addRARow()">+ Agregar RA</button>
            </div>
          </td>
        </tr>
      `;

      // Reset saberes container
      document.getElementById('saberes-container').innerHTML = `
        <tr class="row-saberes-ra" data-ra="RA1">
          <td class="text-center font-extrabold bg-slate-50">RA1</td>
          <td><textarea class="val-con" placeholder="Saber conceptual..."></textarea></td>
          <td><textarea class="val-pro" placeholder="Saber procedimental..."></textarea></td>
          <td><textarea class="val-act" placeholder="Saber actitudinal..."></textarea></td>
        </tr>
      `;

      // Reset competencias container: mantener dos filas base
      document.getElementById('competencias-container').innerHTML = `
        <tr class="row-generica" data-type="generica">
          <td>
            <strong>General:</strong>
            <textarea class="val-comp" placeholder="Competencia general..."></textarea>
            <div class="no-print mt-2 btn-container">
              <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addCompRow('generica')">+ Agregar más</button>
            </div>
          </td>
          <td><textarea class="val-nivel" placeholder="Ej.: Básico / Intermedio / Avanzado"></textarea></td>
        </tr>

        <tr class="row-especifica" data-type="especifica">
          <td>
            <strong>Específica:</strong>
            <textarea class="val-comp" placeholder="Competencia específica..."></textarea>
            <div class="no-print mt-2 btn-container">
              <button class="btn btn-green !py-2 !px-3 !rounded-lg !text-sm" onclick="addCompRow('especifica')">+ Agregar más</button>
            </div>
          </td>
          <td><textarea class="val-nivel" placeholder="Ej.: Básico / Intermedio / Avanzado"></textarea></td>
        </tr>
      `;

      // Reset notas
      document.getElementById('notas-container').innerHTML = '';
      addNotaRowToRA(1);

      // Reset semanas placeholders
      initSemanas();

      // Reset prompt
      setDefaultPrompt();
    }

    Object.assign(window, {
      handlePrint,
      openPromptModal,
      closePromptModal,
      copyPrompt,
      fillPromptFromForm,
      addCompRow,
      addRARow,
      addNotaRowToRA,
      clearForm,
    });

    // Cerrar modal con Escape / click fuera
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closePromptModal();
    });

    document.getElementById('promptModal').addEventListener('click', (e) => {
      if (e.target && e.target.id === 'promptModal') closePromptModal();
    });

    window.onload = initApp;
  </script>
</body>
</html>
